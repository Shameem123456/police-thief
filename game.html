<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game - Police & Thief</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .room-info {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #e2e8f0;
        }

        .phase-indicator {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            min-height: 70vh;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* Sidebar Styles */
        .sidebar {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: fit-content;
        }

        .role-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.2));
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .role-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .role-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #c4b5fd;
        }

        .role-score {
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            color: #fbbf24;
        }

        .role-description {
            color: #cbd5e1;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .hide-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .hide-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .player-list {
            margin-top: 20px;
        }

        .player-list h3 {
            color: #94a3b8;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background 0.3s ease;
        }

        .player-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .player-name {
            font-weight: 500;
        }

        .player-status {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 12px;
        }

        .status-waiting {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .status-ready {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        /* Game Area Styles */
        .game-area {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 600px;
        }

        /* Box Selection Phase */
        .box-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .box {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #475569, #334155);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .box:hover {
            transform: translateY(-5px);
            border-color: #8b5cf6;
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3);
        }

        .box.selected {
            background: linear-gradient(135deg, #10b981, #059669);
            cursor: default;
            border-color: #10b981;
        }

        .box-number {
            font-size: 2rem;
            font-weight: bold;
            color: white;
        }

        .box-status {
            font-size: 0.8rem;
            margin-top: 5px;
            color: rgba(255, 255, 255, 0.8);
        }

        .box.selected::after {
            content: '‚úì';
            position: absolute;
            top: 5px;
            right: 5px;
            background: white;
            color: #10b981;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .turn-indicator {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .turn-indicator h3 {
            color: #c4b5fd;
            margin-bottom: 10px;
        }

        .current-player {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fbbf24;
        }

        /* Investigation & Action Phases */
        .phase-title {
            text-align: center;
            font-size: 1.8rem;
            margin-bottom: 30px;
            color: #e2e8f0;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(139, 92, 246, 0.3);
        }

        .phase-description {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 40px;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .action-panel {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message-box {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .message-box h4 {
            color: #c4b5fd;
            margin-bottom: 10px;
        }

        .message-content {
            color: #e2e8f0;
            font-style: italic;
        }

        .player-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .select-player-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .select-player-btn:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: #8b5cf6;
        }

        .select-player-btn.selected {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .action-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.4);
        }

        .action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .action-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Timer Styles */
        .timer-container {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timer-display {
            font-size: 3rem;
            font-weight: bold;
            color: #fbbf24;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .timer-label {
            color: #94a3b8;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Results Phase */
        .results-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .result-card {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .result-player {
            font-size: 1.3rem;
            font-weight: bold;
            color: #e2e8f0;
        }

        .result-role {
            color: #c4b5fd;
            font-style: italic;
        }

        .result-score {
            font-size: 1.4rem;
            font-weight: bold;
            color: #fbbf24;
        }

        .score-breakdown {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #cbd5e1;
        }

        .score-item.total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: bold;
            color: #fbbf24;
        }

        .bonus {
            color: #4ade80;
        }

        .penalty {
            color: #f87171;
        }

        .thief-outcome {
            text-align: center;
            padding: 30px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 15px;
            margin: 30px 0;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .outcome-message {
            font-size: 1.8rem;
            font-weight: bold;
            color: #fbbf24;
            margin-bottom: 15px;
        }

        .next-cycle-btn {
            display: block;
            margin: 40px auto;
            padding: 18px 40px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .next-cycle-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(16, 185, 129, 0.4);
        }

        .next-cycle-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 50px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #8b5cf6;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #94a3b8;
            font-size: 1.1rem;
        }

        /* Error Message */
        .error-message {
            background: rgba(239, 68, 68, 0.2);
            color: #fecaca;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid rgba(239, 68, 68, 0.3);
            display: none;
        }

        .error-message.active {
            display: block;
        }

        /* Role-specific highlights */
        .role-police { color: #60a5fa; }
        .role-thief { color: #f87171; }
        .role-minister { color: #34d399; }
        .role-jester { color: #fbbf24; }
        .role-spy { color: #c084fc; }
        .role-knight { color: #a78bfa; }
        .role-king { color: #fbbf24; }
        .role-queen { color: #f9a8d4; }
        .role-prince { color: #93c5fd; }
        .role-treasurer { color: #fcd34d; }
        .role-citizen { color: #9ca3af; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="room-info">
                <div class="info-item">
                    <div class="info-label">Room ID</div>
                    <div class="info-value" id="roomIdDisplay">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Cycle</div>
                    <div class="info-value" id="cycleDisplay">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Players</div>
                    <div class="info-value" id="playersCountDisplay">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Your Score</div>
                    <div class="info-value" id="playerScoreDisplay">0</div>
                </div>
            </div>
            <div class="phase-indicator" id="phaseIndicator">Loading...</div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message"></div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="role-card">
                    <div class="role-header">
                        <div class="role-title" id="playerRole">Loading...</div>
                        <div class="role-score" id="roleScore">0</div>
                    </div>
                    <div class="role-description" id="roleDescription">
                        Loading role description...
                    </div>
                    <button class="hide-btn" onclick="toggleRoleVisibility()" id="hideRoleBtn">
                        Hide Role
                    </button>
                </div>

                <div class="player-list">
                    <h3>Players in Game</h3>
                    <div id="playersList">
                        <!-- Player items will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Game Area -->
            <div class="game-area">
                <!-- Loading State -->
                <div id="loadingState" class="loading">
                    <div class="spinner"></div>
                    <div class="loading-text">Loading game state...</div>
                </div>

                <!-- Box Selection Phase -->
                <div id="boxSelectionPhase" class="game-phase" style="display: none;">
                    <h2 class="phase-title">Select Your Box</h2>
                    <p class="phase-description">
                        Boxes contain random roles. Select one box when it's your turn.<br>
                        Once selected, your role will be revealed only to you.
                    </p>

                    <div class="turn-indicator" id="turnIndicator">
                        <h3>Current Turn</h3>
                        <div class="current-player" id="currentPlayer">-</div>
                    </div>

                    <div class="box-grid" id="boxGrid">
                        <!-- Boxes will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Investigation Phase (Minister & Jester) -->
                <div id="investigationPhase" class="game-phase" style="display: none;">
                    <h2 class="phase-title">Investigation Phase</h2>
                    <p class="phase-description" id="investigationDescription">
                        You have 1 minute to investigate one player. Choose wisely!
                    </p>

                    <div class="timer-container">
                        <div class="timer-label">Time Remaining</div>
                        <div class="timer-display" id="investigationTimer">01:00</div>
                    </div>

                    <div class="action-panel">
                        <div class="player-select-grid" id="investigationPlayers">
                            <!-- Player selection buttons will be populated -->
                        </div>
                        
                        <div class="action-buttons">
                            <button class="action-btn primary" onclick="submitInvestigation()" id="submitInvestigationBtn">
                                Submit Investigation
                            </button>
                            <button class="action-btn secondary" onclick="skipInvestigation()">
                                Skip Investigation
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Spy Phase -->
                <div id="spyPhase" class="game-phase" style="display: none;">
                    <h2 class="phase-title">Spy Phase</h2>
                    <p class="phase-description">
                        Identify the Minister and Jester. You get +200 points for each correct identification.
                    </p>

                    <div class="timer-container">
                        <div class="timer-label">Time Remaining</div>
                        <div class="timer-display" id="spyTimer">01:00</div>
                    </div>

                    <div class="action-panel">
                        <h3 style="text-align: center; margin-bottom: 20px; color: #c084fc;">
                            Select Minister
                        </h3>
                        <div class="player-select-grid" id="ministerSelection">
                            <!-- Minister selection buttons -->
                        </div>

                        <h3 style="text-align: center; margin: 30px 0 20px; color: #fbbf24;">
                            Select Jester
                        </h3>
                        <div class="player-select-grid" id="jesterSelection">
                            <!-- Jester selection buttons -->
                        </div>
                        
                        <div class="action-buttons">
                            <button class="action-btn primary" onclick="submitSpyPredictions()" id="submitSpyBtn">
                                Submit Predictions
                            </button>
                            <button class="action-btn secondary" onclick="skipSpyPredictions()">
                                Skip Predictions
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Action Phase (Police & Knight) -->
                <div id="actionPhase" class="game-phase" style="display: none;">
                    <h2 class="phase-title">Action Phase</h2>
                    <p class="phase-description" id="actionDescription">
                        <!-- Will be set based on role -->
                    </p>

                    <div class="message-box" id="messagesBox" style="display: none;">
                        <h4>üì® You Received Messages</h4>
                        <div class="message-content" id="messagesContent">
                            <!-- Messages will be populated -->
                        </div>
                    </div>

                    <div class="timer-container">
                        <div class="timer-label">Time Remaining</div>
                        <div class="timer-display" id="actionTimer">03:00</div>
                    </div>

                    <div class="action-panel">
                        <div class="player-select-grid" id="actionPlayers">
                            <!-- Player selection buttons -->
                        </div>
                        
                        <div class="action-buttons">
                            <button class="action-btn primary" onclick="submitAction()" id="submitActionBtn">
                                Submit Selection
                            </button>
                            <button class="action-btn secondary" onclick="skipAction()">
                                Skip Action
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Results Phase -->
                <div id="resultsPhase" class="game-phase" style="display: none;">
                    <h2 class="phase-title">Cycle Results</h2>
                    <p class="phase-description">
                        See how everyone performed in this cycle. Scores are added to your total.
                    </p>

                    <div class="thief-outcome" id="thiefOutcome">
                        <!-- Thief outcome will be populated -->
                    </div>

                    <div class="results-container" id="resultsContainer">
                        <!-- Results will be populated -->
                    </div>

                    <button class="next-cycle-btn" onclick="startNextCycle()" id="nextCycleBtn" disabled>
                        Start Next Cycle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzEpsouaUZtaHD7AHx292LfrO8MPyTKECw_6L83Vq5ddMvKFLwNjephdrwJfuzHyg1u/exec';
        let gameData = JSON.parse(localStorage.getItem('gameData'));
        let currentGameState = null;
        let pollInterval = null;
        let countdownInterval = null;
        let remainingTime = 0;
        let selectedBoxId = null;
        let selectedPlayer = null;
        let selectedMinister = null;
        let selectedJester = null;
        let playerRole = '';

        if (!gameData) {
            window.location.href = 'index.html';
        }

        // Game state constants
        const GAME_STATES = {
            LOBBY: 'LOBBY',
            BOX_SELECTION: 'BOX_SELECTION',
            INVESTIGATION: 'INVESTIGATION',
            ACTION: 'ACTION',
            RESULT: 'RESULT',
            ENDED: 'ENDED'
        };

        const ROLES = {
            POLICE: 'Police',
            THIEF: 'Thief',
            MINISTER: 'Minister',
            JESTER: 'Jester',
            SPY: 'Spy',
            KNIGHT: 'Knight',
            KING: 'King',
            QUEEN: 'Queen',
            PRINCE: 'Prince',
            TREASURER: 'Treasurer',
            CITIZEN: 'Citizen'
        };

        // Role descriptions
        const ROLE_DESCRIPTIONS = {
            'Police': 'You must identify the Thief within 3 minutes. If correct, you get 900 points. If wrong or no selection, you get 0 points.',
            'Thief': 'Your goal is to escape detection. You get 900 points if Police fails to identify you or if Knight protects you.',
            'Minister': 'Investigate one player to learn their true role. Your information helps Police. +300 bonus if Police catches Thief.',
            'Jester': 'Investigate one player to learn their true role. Your information misleads Police. +300 bonus if Knight protects Thief.',
            'Spy': 'Identify the Minister and Jester. +200 points for each correct identification.',
            'Knight': 'Protect one player. If you protect the Thief, you get +300 bonus.',
            'King': 'Royalty with highest base score (1000). No special abilities.',
            'Queen': 'Royalty with high base score (800). No special abilities.',
            'Prince': 'Royalty with good base score (750). No special abilities.',
            'Treasurer': 'Wealth collector with moderate score (550). No special abilities.',
            'Citizen': 'Common folk with basic score (200). No special abilities.'
        };

        // Role base scores
        const ROLE_SCORES = {
            'King': 1000,
            'Queen': 800,
            'Prince': 750,
            'Knight': 600,
            'Jester': 400,
            'Minister': 700,
            'Spy': 650,
            'Treasurer': 550,
            'Police': 900,
            'Thief': 0,
            'Citizen': 200
        };

        async function fetchGameState() {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'getGameState',
                        roomId: gameData.roomId,
                        playerName: gameData.playerName
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    return result.data;
                } else {
                    showError(result.data || 'Failed to fetch game state');
                    return null;
                }
            } catch (error) {
                console.error('Error fetching game state:', error);
                showError('Network error. Trying to reconnect...');
                return null;
            }
        }

        async function updateGameDisplay() {
            const state = await fetchGameState();
            
            if (!state) return;
            
            currentGameState = state;
            
            // Update header information
            document.getElementById('roomIdDisplay').textContent = gameData.roomId;
            document.getElementById('cycleDisplay').textContent = state.cycle || 1;
            document.getElementById('playersCountDisplay').textContent = state.players?.length || 0;
            
            // Update player list
            updatePlayersList(state.players || []);
            
            // Update player's role and score if available
            if (state.playerRole) {
                playerRole = state.playerRole;
                updatePlayerRoleDisplay();
            }
            
            // Update phase indicator
            document.getElementById('phaseIndicator').textContent = 
                state.gameState?.replace('_', ' ') || 'Unknown';
            
            // Show appropriate phase
            showGamePhase(state.gameState || GAME_STATES.LOBBY);
            
            // Hide loading state
            document.getElementById('loadingState').style.display = 'none';
            
            // Update specific phase content
            switch(state.gameState) {
                case GAME_STATES.BOX_SELECTION:
                    updateBoxSelectionPhase(state);
                    break;
                case GAME_STATES.INVESTIGATION:
                    updateInvestigationPhase(state);
                    break;
                case GAME_STATES.ACTION:
                    updateActionPhase(state);
                    break;
                case GAME_STATES.RESULT:
                    updateResultsPhase(state);
                    break;
            }
        }

        function updatePlayerRoleDisplay() {
            if (!playerRole) return;
            
            document.getElementById('playerRole').textContent = playerRole;
            document.getElementById('playerRole').className = `role-title role-${playerRole.toLowerCase()}`;
            document.getElementById('roleScore').textContent = ROLE_SCORES[playerRole] || 0;
            document.getElementById('roleDescription').textContent = ROLE_DESCRIPTIONS[playerRole] || '';
        }

        function updatePlayersList(players) {
            const container = document.getElementById('playersList');
            container.innerHTML = '';
            
            players.forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-item';
                
                if (player.name === gameData.playerName) {
                    div.style.background = 'rgba(139, 92, 246, 0.2)';
                }
                
                div.innerHTML = `
                    <div class="player-name">${player.name}</div>
                    <div class="player-status ${player.ready ? 'status-ready' : 'status-waiting'}">
                        ${player.ready ? 'Ready' : 'Waiting'}
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function showGamePhase(phase) {
            // Hide all phases first
            const phases = document.querySelectorAll('.game-phase');
            phases.forEach(phase => phase.style.display = 'none');
            
            // Show loading if phase is not recognized
            if (!phase) {
                document.getElementById('loadingState').style.display = 'block';
                return;
            }
            
            // Show the correct phase
            switch(phase) {
                case GAME_STATES.BOX_SELECTION:
                    document.getElementById('boxSelectionPhase').style.display = 'block';
                    break;
                case GAME_STATES.INVESTIGATION:
                    if (playerRole === ROLES.MINISTER || playerRole === ROLES.JESTER) {
                        document.getElementById('investigationPhase').style.display = 'block';
                    } else if (playerRole === ROLES.SPY) {
                        document.getElementById('spyPhase').style.display = 'block';
                    } else {
                        document.getElementById('actionPhase').style.display = 'block';
                    }
                    break;
                case GAME_STATES.ACTION:
                    document.getElementById('actionPhase').style.display = 'block';
                    break;
                case GAME_STATES.RESULT:
                    document.getElementById('resultsPhase').style.display = 'block';
                    break;
                default:
                    document.getElementById('loadingState').style.display = 'block';
            }
        }

        function updateBoxSelectionPhase(state) {
            const boxes = state.boxes || [];
            const turnOrder = state.turnOrder || [];
            const currentTurn = state.currentTurn || 0;
            const currentPlayer = turnOrder[currentTurn] || '';
            
            // Update turn indicator
            document.getElementById('currentPlayer').textContent = currentPlayer;
            
            // Create boxes
            const boxGrid = document.getElementById('boxGrid');
            boxGrid.innerHTML = '';
            
            boxes.forEach((box, index) => {
                const boxElement = document.createElement('div');
                boxElement.className = `box ${box.selected ? 'selected' : ''}`;
                boxElement.onclick = () => selectBox(box.id);
                
                // Disable if not player's turn or already selected
                if (currentPlayer !== gameData.playerName || box.selected) {
                    boxElement.style.pointerEvents = 'none';
                    boxElement.style.opacity = box.selected ? '1' : '0.5';
                }
                
                boxElement.innerHTML = `
                    <div class="box-number">${box.id}</div>
                    <div class="box-status">${box.selected ? 'Selected' : 'Available'}</div>
                `;
                
                boxGrid.appendChild(boxElement);
            });
        }

        async function selectBox(boxId) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'selectBox',
                        roomId: gameData.roomId,
                        playerName: gameData.playerName,
                        boxId: boxId
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    selectedBoxId = boxId;
                    playerRole = result.data.role;
                    updatePlayerRoleDisplay();
                    
                    if (result.data.allSelected) {
                        showError('All boxes selected! Moving to next phase...');
                    }
                } else {
                    showError(result.data);
                }
            } catch (error) {
                showError('Error selecting box');
            }
        }

        function updateInvestigationPhase(state) {
            const description = document.getElementById('investigationDescription');
            
            if (playerRole === ROLES.MINISTER) {
                description.textContent = 'Investigate one player to learn their role. Your information will help Police catch the Thief.';
            } else if (playerRole === ROLES.JESTER) {
                description.textContent = 'Investigate one player to learn their role. Your information will mislead Police.';
            }
            
            // Update player selection list
            updatePlayerSelectionGrid('investigationPlayers', state.players || [], 'selectPlayerForInvestigation');
            
            // Start timer
            startTimer('investigationTimer', 60);
        }

        function updateSpyPhase(state) {
            updatePlayerSelectionGrid('ministerSelection', state.players || [], 'selectMinister');
            updatePlayerSelectionGrid('jesterSelection', state.players || [], 'selectJester');
            startTimer('spyTimer', 60);
        }

        function updateActionPhase(state) {
            const description = document.getElementById('actionDescription');
            const messagesBox = document.getElementById('messagesBox');
            
            if (playerRole === ROLES.POLICE) {
                description.textContent = 'You have 3 minutes to identify the Thief. You received 2 messages - one true and one false.';
                messagesBox.style.display = 'block';
                // TODO: Display actual messages from server
                document.getElementById('messagesContent').innerHTML = `
                    <p>Message 1: "Player X is King"</p>
                    <p>Message 2: "Player Y is King"</p>
                `;
            } else if (playerRole === ROLES.KNIGHT) {
                description.textContent = 'Select one player to protect. If you protect the Thief, you get bonus points.';
                messagesBox.style.display = 'block';
                // TODO: Display actual messages from server
                document.getElementById('messagesContent').innerHTML = `
                    <p>Message 1: "Player X is King"</p>
                    <p>Message 2: "Player Y is King"</p>
                `;
            } else {
                description.textContent = 'Waiting for other players to complete their actions...';
                messagesBox.style.display = 'none';
            }
            
            // Update player selection list
            updatePlayerSelectionGrid('actionPlayers', state.players || [], 'selectPlayerForAction');
            
            // Start timer
            startTimer('actionTimer', 180);
        }

        function updatePlayerSelectionGrid(elementId, players, clickHandler) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            
            players.forEach(player => {
                if (player.name === gameData.playerName) return; // Don't show self
                
                const button = document.createElement('button');
                button.className = 'select-player-btn';
                button.textContent = player.name;
                button.onclick = () => window[clickHandler](player.name, button);
                
                container.appendChild(button);
            });
        }

        function selectPlayerForInvestigation(playerName, button) {
            selectedPlayer = playerName;
            
            // Update button states
            document.querySelectorAll('#investigationPlayers .select-player-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            button.classList.add('selected');
            
            document.getElementById('submitInvestigationBtn').disabled = false;
        }

        function selectMinister(playerName, button) {
            selectedMinister = playerName;
            
            // Update button states
            document.querySelectorAll('#ministerSelection .select-player-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            button.classList.add('selected');
            
            updateSpySubmitButton();
        }

        function selectJester(playerName, button) {
            selectedJester = playerName;
            
            // Update button states
            document.querySelectorAll('#jesterSelection .select-player-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            button.classList.add('selected');
            
            updateSpySubmitButton();
        }

        function selectPlayerForAction(playerName, button) {
            selectedPlayer = playerName;
            
            // Update button states
            document.querySelectorAll('#actionPlayers .select-player-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            button.classList.add('selected');
            
            document.getElementById('submitActionBtn').disabled = false;
        }

        function updateSpySubmitButton() {
            const submitBtn = document.getElementById('submitSpyBtn');
            submitBtn.disabled = !(selectedMinister && selectedJester);
        }

        async function submitInvestigation() {
            if (!selectedPlayer) {
                showError('Please select a player to investigate');
                return;
            }
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'submitAction',
                        roomId: gameData.roomId,
                        playerName: gameData.playerName,
                        action: 'investigate',
                        target: selectedPlayer
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showError('Investigation submitted!');
                } else {
                    showError(result.data);
                }
            } catch (error) {
                showError('Error submitting investigation');
            }
        }

        async function submitSpyPredictions() {
            if (!selectedMinister || !selectedJester) {
                showError('Please select both Minister and Jester');
                return;
            }
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'submitAction',
                        roomId: gameData.roomId,
                        playerName: gameData.playerName,
                        action: 'spy_predictions',
                        target: JSON.stringify({
                            minister: selectedMinister,
                            jester: selectedJester
                        })
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showError('Predictions submitted!');
                } else {
                    showError(result.data);
                }
            } catch (error) {
                showError('Error submitting predictions');
            }
        }

        async function submitAction() {
            if (!selectedPlayer) {
                showError('Please select a player');
                return;
            }
            
            const action = playerRole === ROLES.POLICE ? 'predict_thief' : 'protect_player';
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'submitAction',
                        roomId: gameData.roomId,
                        playerName: gameData.playerName,
                        action: action,
                        target: selectedPlayer
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showError('Action submitted!');
                } else {
                    showError(result.data);
                }
            } catch (error) {
                showError('Error submitting action');
            }
        }

        function skipInvestigation() {
            selectedPlayer = null;
            showError('Investigation skipped');
        }

        function skipSpyPredictions() {
            selectedMinister = null;
            selectedJester = null;
            showError('Predictions skipped');
        }

        function skipAction() {
            selectedPlayer = null;
            showError('Action skipped');
        }

        function startTimer(timerElementId, seconds) {
            clearInterval(countdownInterval);
            
            remainingTime = seconds;
            updateTimerDisplay(timerElementId);
            
            countdownInterval = setInterval(() => {
                remainingTime--;
                updateTimerDisplay(timerElementId);
                
                if (remainingTime <= 0) {
                    clearInterval(countdownInterval);
                    // Auto-submit if time runs out
                    if (timerElementId === 'investigationTimer') {
                        skipInvestigation();
                    } else if (timerElementId === 'spyTimer') {
                        skipSpyPredictions();
                    } else if (timerElementId === 'actionTimer') {
                        skipAction();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay(timerElementId) {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            document.getElementById(timerElementId).textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateResultsPhase(state) {
            const results = state.results || [];
            const thiefOutcome = state.thiefOutcome || {};
            
            // Update thief outcome
            const outcomeDiv = document.getElementById('thiefOutcome');
            if (thiefOutcome.caught) {
                outcomeDiv.innerHTML = `
                    <div class="outcome-message">üö® THIEF CAUGHT!</div>
                    <p>Police successfully identified the Thief!</p>
                `;
            } else {
                outcomeDiv.innerHTML = `
                    <div class="outcome-message">üèÉ THIEF ESCAPED!</div>
                    <p>The Thief managed to avoid detection!</p>
                `;
            }
            
            // Update results
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '';
            
            results.forEach(result => {
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';
                
                resultCard.innerHTML = `
                    <div class="result-header">
                        <div>
                            <div class="result-player">${result.player}</div>
                            <div class="result-role">${result.role}</div>
                        </div>
                        <div class="result-score">${result.totalScore}</div>
                    </div>
                    <div class="score-breakdown">
                        ${result.breakdown ? result.breakdown.map(item => `
                            <div class="score-item">
                                <span>${item.description}</span>
                                <span class="${item.type === 'bonus' ? 'bonus' : item.type === 'penalty' ? 'penalty' : ''}">
                                    ${item.score > 0 ? '+' : ''}${item.score}
                                </span>
                            </div>
                        `).join('') : ''}
                        <div class="score-item total">
                            <span>Total Cycle Score</span>
                            <span>${result.cycleScore}</span>
                        </div>
                    </div>
                `;
                
                resultsContainer.appendChild(resultCard);
            });
            
            // Enable next cycle button for host
            const nextCycleBtn = document.getElementById('nextCycleBtn');
            nextCycleBtn.disabled = !gameData.isHost;
            
            if (gameData.isHost) {
                nextCycleBtn.textContent = 'Start Next Cycle';
            } else {
                nextCycleBtn.textContent = 'Waiting for Host...';
            }
        }

        async function startNextCycle() {
            if (!gameData.isHost) return;
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'startNextCycle',
                        roomId: gameData.roomId,
                        playerName: gameData.playerName
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showError('Starting next cycle...');
                    // Reset selections for new cycle
                    selectedBoxId = null;
                    selectedPlayer = null;
                    selectedMinister = null;
                    selectedJester = null;
                } else {
                    showError(result.data);
                }
            } catch (error) {
                showError('Error starting next cycle');
            }
        }

        function toggleRoleVisibility() {
            const roleCard = document.querySelector('.role-card');
            const hideBtn = document.getElementById('hideRoleBtn');
            
            if (roleCard.style.opacity === '0.1') {
                roleCard.style.opacity = '1';
                hideBtn.textContent = 'Hide Role';
            } else {
                roleCard.style.opacity = '0.1';
                hideBtn.textContent = 'Show Role';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
            setTimeout(() => errorDiv.classList.remove('active'), 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateGameDisplay();
            
            // Poll for game state updates every 2 seconds
            pollInterval = setInterval(updateGameDisplay, 2000);
            
            // Display player name in console for debugging
            console.log('Player:', gameData.playerName);
            console.log('Room:', gameData.roomId);
            console.log('Is Host:', gameData.isHost);
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            clearInterval(pollInterval);
            clearInterval(countdownInterval);
        });
    </script>
</body>
                      </html>
