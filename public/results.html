<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results - Police & Thief</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #00b09b, #96c93d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0, 176, 155, 0.3);
        }

        .header p {
            color: #b0b0d0;
            font-size: 1.3rem;
        }

        .cycle-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .cycle-card {
            padding: 20px 30px;
            background: rgba(142, 45, 226, 0.1);
            border-radius: 15px;
            border: 2px solid rgba(142, 45, 226, 0.3);
            text-align: center;
            min-width: 180px;
            transition: all 0.3s;
        }

        .cycle-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(142, 45, 226, 0.2);
        }

        .cycle-label {
            font-size: 1rem;
            color: #b0b0d0;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .cycle-value {
            font-size: 2rem;
            font-weight: bold;
            color: #8e2de2;
            text-shadow: 0 0 10px rgba(142, 45, 226, 0.5);
        }

        .results-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        @media (max-width: 1000px) {
            .results-content {
                grid-template-columns: 1fr;
            }
        }

        .leaderboard-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section-title {
            font-size: 2rem;
            margin-bottom: 30px;
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 15px;
            overflow: hidden;
        }

        .leaderboard-table thead {
            background: rgba(142, 45, 226, 0.2);
        }

        .leaderboard-table th {
            padding: 20px;
            text-align: left;
            color: #8e2de2;
            font-weight: bold;
            font-size: 1.1rem;
            border-bottom: 2px solid rgba(142, 45, 226, 0.3);
        }

        .leaderboard-table td {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .leaderboard-table tr:hover td {
            background: rgba(255, 255, 255, 0.05);
        }

        .leaderboard-table tr:last-child td {
            border-bottom: none;
        }

        .rank {
            font-weight: bold;
            text-align: center;
            width: 70px;
            font-size: 1.2rem;
        }

        .rank-1 {
            color: gold;
            font-size: 1.5rem;
        }

        .rank-2 {
            color: silver;
            font-size: 1.4rem;
        }

        .rank-3 {
            color: #cd7f32;
            font-size: 1.3rem;
        }

        .player-name {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .player-role {
            color: #b0b0d0;
            font-size: 0.9rem;
        }

        .score-positive {
            color: #28a745;
            font-weight: bold;
        }

        .score-negative {
            color: #dc3545;
            font-weight: bold;
        }

        .score-neutral {
            color: #b0b0d0;
            font-weight: bold;
        }

        .score-change {
            font-size: 0.9rem;
            color: #b0b0d0;
        }

        .score-change.positive {
            color: #28a745;
        }

        .score-change.negative {
            color: #dc3545;
        }

        .details-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: fit-content;
        }

        .role-breakdown {
            margin-top: 30px;
        }

        .role-item {
            padding: 20px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border-left: 5px solid;
            transition: all 0.3s;
        }

        .role-item:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.08);
        }

        .role-item.king { border-left-color: gold; }
        .role-item.queen { border-left-color: silver; }
        .role-item.prince { border-left-color: #cd7f32; }
        .role-item.minister { border-left-color: #28a745; }
        .role-item.spy { border-left-color: #17a2b8; }
        .role-item.police { border-left-color: #007bff; }
        .role-item.knight { border-left-color: #6f42c1; }
        .role-item.jester { border-left-color: #fd7e14; }
        .role-item.thief { border-left-color: #dc3545; }
        .role-item.treasurer { border-left-color: #20c997; }
        .role-item.citizen { border-left-color: #6c757d; }

        .role-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .role-name {
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .role-score {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .role-description {
            font-size: 0.95rem;
            color: #b0b0d0;
            line-height: 1.5;
        }

        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 40px 0;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 20px 40px;
            font-size: 1.3rem;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            min-width: 220px;
        }

        .btn-next {
            background: linear-gradient(45deg, #00b09b, #96c93d);
            color: white;
        }

        .btn-next:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 176, 155, 0.4);
        }

        .btn-leaderboard {
            background: linear-gradient(45deg, #8e2de2, #4a00e0);
            color: white;
        }

        .btn-leaderboard:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(142, 45, 226, 0.4);
        }

        .btn-lobby {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .btn-lobby:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-5px);
        }

        .loading {
            text-align: center;
            padding: 80px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #8e2de2;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 20px 30px;
            background: rgba(40, 167, 69, 0.9);
            color: white;
            border-radius: 10px;
            animation: slideIn 0.3s;
            z-index: 1000;
            display: none;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .notification.error {
            background: rgba(220, 53, 69, 0.9);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .final-results {
            text-align: center;
            padding: 50px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            margin-top: 30px;
            display: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .winner-title {
            font-size: 2.5rem;
            color: gold;
            margin-bottom: 30px;
            animation: glow 2s infinite;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        @keyframes glow {
            0%, 100% { 
                text-shadow: 0 0 20px gold, 0 0 40px rgba(255, 215, 0, 0.3);
            }
            50% { 
                text-shadow: 0 0 30px gold, 0 0 60px rgba(255, 215, 0, 0.5);
            }
        }

        .winner-name {
            font-size: 3.5rem;
            font-weight: bold;
            margin: 30px 0;
            background: linear-gradient(45deg, gold, silver, #cd7f32);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }

        .winner-score {
            font-size: 2.5rem;
            color: #28a745;
            margin-bottom: 40px;
            text-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
        }

        .game-details {
            margin-top: 40px;
            text-align: left;
            background: rgba(0, 0, 0, 0.2);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .game-details h3 {
            color: #8e2de2;
            margin-bottom: 20px;
            font-size: 1.5rem;
            text-align: center;
        }

        .detail-item {
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #b0b0d0;
            font-size: 1.1rem;
        }

        .detail-value {
            color: #8e2de2;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .trophy {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .medal {
            display: inline-block;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
        }

        .medal-gold {
            background: radial-gradient(circle at 30% 30%, gold, #daa520);
            box-shadow: 0 0 20px gold;
        }

        .medal-silver {
            background: radial-gradient(circle at 30% 30%, silver, #c0c0c0);
            box-shadow: 0 0 20px silver;
        }

        .medal-bronze {
            background: radial-gradient(circle at 30% 30%, #cd7f32, #8b4513);
            box-shadow: 0 0 20px #cd7f32;
        }

        .player-highlight {
            background: rgba(142, 45, 226, 0.1) !important;
            border-left: 4px solid #8e2de2;
        }

        .results-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .results-action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .results-action-btn.primary {
            background: #8e2de2;
            color: white;
        }

        .results-action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .results-action-btn:hover {
            transform: translateY(-2px);
        }

        .cycle-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }

        .cycle-nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .cycle-nav-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .cycle-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .cycle-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #8e2de2;
            min-width: 100px;
            text-align: center;
        }

        .score-breakdown {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #b0b0d0;
        }

        .score-breakdown span {
            margin-right: 10px;
        }

        .score-breakdown .base {
            color: #b0b0d0;
        }

        .score-breakdown .bonus {
            color: #28a745;
        }

        .score-breakdown .penalty {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>
    
    <div class="container">
        <div class="header">
            <h1>Cycle Results</h1>
            <p>Here are the results for this cycle</p>
            
            <div class="cycle-info">
                <div class="cycle-card">
                    <div class="cycle-label">Current Cycle</div>
                    <div class="cycle-value" id="currentCycle">1</div>
                </div>
                <div class="cycle-card">
                    <div class="cycle-label">Total Cycles</div>
                    <div class="cycle-value" id="totalCycles">5</div>
                </div>
                <div class="cycle-card">
                    <div class="cycle-label">Players</div>
                    <div class="cycle-value" id="playerCount">0</div>
                </div>
                <div class="cycle-card">
                    <div class="cycle-label">Your Score</div>
                    <div class="cycle-value" id="yourScore">0</div>
                </div>
            </div>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading results...</p>
        </div>
        
        <div id="resultsContent" style="display: none;">
            <div class="cycle-navigation">
                <button class="cycle-nav-btn" id="prevCycleBtn" onclick="changeCycle(-1)" disabled>‚Üê</button>
                <div class="cycle-display">Cycle <span id="displayCycle">1</span></div>
                <button class="cycle-nav-btn" id="nextCycleBtn" onclick="changeCycle(1)">‚Üí</button>
            </div>
            
            <div class="results-content">
                <div class="leaderboard-section">
                    <h2 class="section-title">üèÜ Leaderboard</h2>
                    <table class="leaderboard-table" id="leaderboardTable">
                        <thead>
                            <tr>
                                <th class="rank">Rank</th>
                                <th>Player</th>
                                <th>Role</th>
                                <th>Cycle Score</th>
                                <th>Total Score</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody">
                            <!-- Generated dynamically -->
                        </tbody>
                    </table>
                </div>
                
                <div class="details-section">
                    <h2 class="section-title">üìä Game Details</h2>
                    <div id="gameDetails">
                        <!-- Generated dynamically -->
                    </div>
                    
                    <div class="role-breakdown" id="roleBreakdown">
                        <h3 style="color: #8e2de2; margin-bottom: 20px;">üé≠ Role Distribution</h3>
                        <!-- Generated dynamically -->
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn btn-next" id="nextCycleActionBtn" onclick="startNextCycle()">Next Cycle</button>
                <button class="action-btn btn-leaderboard" id="finalLeaderboardBtn" onclick="showFinalLeaderboard()" style="display: none;">Final Leaderboard</button>
                <button class="action-btn btn-lobby" onclick="returnToLobby()">Return to Lobby</button>
            </div>
            
            <div class="final-results" id="finalResults">
                <div class="trophy">üèÜ</div>
                <h2 class="winner-title">üéâ Game Complete! üéâ</h2>
                <div class="winner-name" id="winnerName"></div>
                <div class="winner-score" id="winnerScore"></div>
                <p style="color: #b0b0d0; font-size: 1.2rem; margin-bottom: 40px;">Congratulations to the winner!</p>
                
                <div class="game-details">
                    <h3>Game Statistics</h3>
                    <div class="detail-item">
                        <span class="detail-label">Total Cycles Played:</span>
                        <span class="detail-value" id="totalCyclesPlayed">0</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Total Players:</span>
                        <span class="detail-value" id="totalPlayers">0</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Your Final Rank:</span>
                        <span class="detail-value" id="yourFinalRank">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Your Final Score:</span>
                        <span class="detail-value" id="yourFinalScore">0</span>
                    </div>
                </div>
                
                <div class="results-actions" style="margin-top: 40px;">
                    <button class="results-action-btn primary" onclick="playAgain()">Play Again</button>
                    <button class="results-action-btn secondary" onclick="returnToLobby()">Back to Lobby</button>
                    <button class="results-action-btn secondary" onclick="goHome()">Home</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get backend URL from localStorage
        const BACKEND_URL = localStorage.getItem('backendUrl') || "https://script.google.com/macros/s/AKfycbzgLkQWDLF8EkLdgMcZ8-OyBO31vjcGSMfDsmWczjsn3IKdJTEz0HSvId2wttyr0ltPYQ/exec";
        
        // Game state variables
        let resultsData = {};
        let hostId = '';
        let playerId = '';
        let playerName = '';
        let isHost = false;
        let currentCycle = 1;
        let totalCycles = 5;
        let maxCycles = 5;
        let playerRank = 0;
        
        // Initialize
        window.onload = async function() {
            // Get data from localStorage
            hostId = localStorage.getItem('hostId');
            playerId = localStorage.getItem('playerId');
            playerName = localStorage.getItem('playerName');
            isHost = localStorage.getItem('isHost') === 'true';
            
            if (!hostId || !playerId) {
                showNotification('Missing game data. Please rejoin the game.', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }
            
            // Get current cycle from URL or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const cycle = urlParams.get('cycle') || localStorage.getItem('currentCycle') || 1;
            currentCycle = parseInt(cycle);
            
            // Fetch results
            await fetchResults();
        };
        
        async function fetchResults() {
            try {
                const response = await fetch(`${BACKEND_URL}?action=getResults&hostId=${hostId}&cycle=${currentCycle}`);
                const data = await response.json();
                
                if (data.success) {
                    handleResults(data);
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Network error: ' + error.message, 'error');
            }
        }
        
        function handleResults(data) {
            resultsData = data;
            
            // Hide loading, show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('resultsContent').style.display = 'block';
            
            // Update UI
            updateResultsUI();
        }
        
        function updateResultsUI() {
            // Update cycle info
            document.getElementById('currentCycle').textContent = currentCycle;
            document.getElementById('displayCycle').textContent = currentCycle;
            
            // Update total cycles from settings
            if (resultsData.settings) {
                totalCycles = resultsData.settings.cycles || 5;
                maxCycles = totalCycles;
                document.getElementById('totalCycles').textContent = totalCycles;
            }
            
            // Update player count
            document.getElementById('playerCount').textContent = resultsData.players?.length || 0;
            
            // Update your score
            const yourPlayer = resultsData.players?.find(p => p.playerId === playerId);
            if (yourPlayer) {
                document.getElementById('yourScore').textContent = yourPlayer.cycleScore;
                playerRank = getPlayerRank(yourPlayer.playerId);
            }
            
            // Update leaderboard
            updateLeaderboard();
            
            // Update game details
            updateGameDetails();
            
            // Update role breakdown
            updateRoleBreakdown();
            
            // Update navigation buttons
            updateNavigationButtons();
            
            // Check if this is the final cycle
            if (currentCycle >= totalCycles) {
                document.getElementById('nextCycleActionBtn').style.display = 'none';
                document.getElementById('finalLeaderboardBtn').style.display = 'inline-block';
            }
        }
        
        function updateLeaderboard() {
            const leaderboardBody = document.getElementById('leaderboardBody');
            if (!leaderboardBody || !resultsData.players) return;
            
            leaderboardBody.innerHTML = '';
            
            // Sort players by total score (descending)
            const sortedPlayers = [...resultsData.players].sort((a, b) => b.totalScore - a.totalScore);
            
            sortedPlayers.forEach((player, index) => {
                const row = document.createElement('tr');
                
                // Add rank class
                let rankClass = '';
                let rankText = index + 1;
                if (index === 0) {
                    rankClass = 'rank-1';
                    rankText = 'ü•á';
                } else if (index === 1) {
                    rankClass = 'rank-2';
                    rankText = 'ü•à';
                } else if (index === 2) {
                    rankClass = 'rank-3';
                    rankText = 'ü•â';
                }
                
                // Highlight current player
                if (player.playerId === playerId) {
                    row.classList.add('player-highlight');
                }
                
                // Determine score colors
                const cycleScoreClass = player.cycleScore >= 0 ? 'score-positive' : 'score-negative';
                const totalScoreClass = player.totalScore >= 0 ? 'score-positive' : 'score-negative';
                
                // Calculate score change if possible
                let scoreChange = '';
                if (currentCycle > 1) {
                    // In a real implementation, you would compare with previous cycle
                    scoreChange = player.cycleScore >= 0 ? `+${player.cycleScore}` : `${player.cycleScore}`;
                }
                
                row.innerHTML = `
                    <td class="rank ${rankClass}">${rankText}</td>
                    <td>
                        <div class="player-name">${player.name} ${player.playerId === playerId ? '(You)' : ''}</div>
                        ${player.isHost ? '<div class="player-role">üëë Host</div>' : ''}
                    </td>
                    <td>
                        <div class="player-role">${player.role || 'Unknown'}</div>
                    </td>
                    <td class="${cycleScoreClass}">
                        ${player.cycleScore}
                        ${scoreChange ? `<div class="score-change ${player.cycleScore >= 0 ? 'positive' : 'negative'}">${scoreChange}</div>` : ''}
                    </td>
                    <td class="${totalScoreClass}">
                        ${player.totalScore}
                    </td>
                `;
                
                leaderboardBody.appendChild(row);
            });
        }
        
        function getPlayerRank(playerId) {
            if (!resultsData.players) return 0;
            
            const sortedPlayers = [...resultsData.players].sort((a, b) => b.totalScore - a.totalScore);
            const index = sortedPlayers.findIndex(p => p.playerId === playerId);
            return index + 1;
        }
        
        function updateGameDetails() {
            const gameDetails = document.getElementById('gameDetails');
            if (!gameDetails || !resultsData.details) return;
            
            // Find key players and events
            const police = resultsData.details.find(p => p.role === 'Police');
            const thief = resultsData.details.find(p => p.role === 'Thief');
            const minister = resultsData.details.find(p => p.role === 'Minister');
            const jester = resultsData.details.find(p => p.role === 'Jester');
            const spy = resultsData.details.find(p => p.role === 'Spy');
            const knight = resultsData.details.find(p => p.role === 'Knight');
            
            // Get player names
            const getPlayerName = (playerId) => {
                const player = resultsData.players?.find(p => p.playerId === playerId);
                return player?.name || 'Unknown';
            };
            
            let detailsHtml = '<h3 style="color: #8e2de2; margin-bottom: 20px;">üîç Key Events</h3>';
            
            // Police prediction
            if (police && police.policeChoice) {
                const policeTarget = getPlayerName(police.policeChoice);
                const wasCorrect = police.policeChoice === thief?.playerId;
                
                detailsHtml += `
                    <div class="detail-item">
                        <span class="detail-label">Police predicted:</span>
                        <span class="detail-value">${policeTarget}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Prediction was:</span>
                        <span class="detail-value ${wasCorrect ? 'score-positive' : 'score-negative'}">
                            ${wasCorrect ? '‚úÖ CORRECT' : '‚ùå WRONG'}
                        </span>
                    </div>
                `;
            } else if (police) {
                detailsHtml += `
                    <div class="detail-item">
                        <span class="detail-label">Police prediction:</span>
                        <span class="detail-value score-negative">‚ùå No prediction</span>
                    </div>
                `;
            }
            
            // Knight protection
            if (knight && knight.knightChoice) {
                const knightTarget = getPlayerName(knight.knightChoice);
                const protectedThief = knight.knightChoice === thief?.playerId;
                
                detailsHtml += `
                    <div class="detail-item">
                        <span class="detail-label">Knight protected:</span>
                        <span class="detail-value">${knightTarget}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Protected Thief:</span>
                        <span class="detail-value ${protectedThief ? 'score-positive' : 'score-neutral'}">
                            ${protectedThief ? '‚úÖ YES' : '‚ùå NO'}
                        </span>
                    </div>
                `;
            }
            
            // Minister choice
            if (minister && minister.ministerChoice) {
                const ministerTarget = getPlayerName(minister.ministerChoice);
                detailsHtml += `
                    <div class="detail-item">
                        <span class="detail-label">Minister investigated:</span>
                        <span class="detail-value">${ministerTarget}</span>
                    </div>
                `;
            }
            
            // Jester choice
            if (jester && jester.jesterChoice) {
                const jesterTarget = getPlayerName(jester.jesterChoice);
                detailsHtml += `
                    <div class="detail-item">
                        <span class="detail-label">Jester misled about:</span>
                        <span class="detail-value">${jesterTarget}</span>
                    </div>
                `;
            }
            
            // Spy predictions
            if (spy && spy.spyPredictions) {
                try {
                    const predictions = JSON.parse(spy.spyPredictions);
                    if (predictions.minister) {
                        const ministerPred = getPlayerName(predictions.minister);
                        detailsHtml += `
                            <div class="detail-item">
                                <span class="detail-label">Spy predicted Minister:</span>
                                <span class="detail-value">${ministerPred}</span>
                            </div>
                        `;
                    }
                    if (predictions.jester) {
                        const jesterPred = getPlayerName(predictions.jester);
                        detailsHtml += `
                            <div class="detail-item">
                                <span class="detail-label">Spy predicted Jester:</span>
                                <span class="detail-value">${jesterPred}</span>
                            </div>
                        `;
                    }
                } catch (e) {
                    // Ignore parse errors
                }
            }
            
            // Thief status
            if (thief) {
                const policeCorrect = police && police.policeChoice === thief.playerId;
                detailsHtml += `
                    <div class="detail-item">
                        <span class="detail-label">Thief was:</span>
                        <span class="detail-value ${!policeCorrect ? 'score-positive' : 'score-negative'}">
                            ${!policeCorrect ? '‚úÖ Undetected' : '‚ùå Caught'}
                        </span>
                    </div>
                `;
            }
            
            gameDetails.innerHTML = detailsHtml;
        }
        
        function updateRoleBreakdown() {
            const roleBreakdown = document.getElementById('roleBreakdown');
            if (!roleBreakdown || !resultsData.players) return;
            
            // Group by role
            const roles = {};
            resultsData.players.forEach(player => {
                if (!roles[player.role]) {
                    roles[player.role] = {
                        count: 0,
                        players: [],
                        totalScore: 0,
                        avgScore: 0
                    };
                }
                roles[player.role].count++;
                roles[player.role].players.push(player.name);
                roles[player.role].totalScore += player.cycleScore;
            });
            
            // Calculate average scores
            Object.keys(roles).forEach(role => {
                roles[role].avgScore = roles[role].totalScore / roles[role].count;
            });
            
            // Create role items
            roleBreakdown.innerHTML = '<h3 style="color: #8e2de2; margin-bottom: 20px;">üé≠ Role Distribution</h3>';
            
            Object.keys(roles).forEach(role => {
                const roleData = roles[role];
                const roleItem = document.createElement('div');
                roleItem.className = `role-item ${role.toLowerCase()}`;
                
                roleItem.innerHTML = `
                    <div class="role-header">
                        <span class="role-name">${role} (${roleData.count})</span>
                        <span class="role-score ${roleData.avgScore >= 0 ? 'score-positive' : 'score-negative'}">
                            Avg: ${Math.round(roleData.avgScore)}
                        </span>
                    </div>
                    <div class="role-description">
                        Players: ${roleData.players.join(', ')}
                    </div>
                `;
                
                roleBreakdown.appendChild(roleItem);
            });
        }
        
        function updateNavigationButtons() {
            document.getElementById('prevCycleBtn').disabled = currentCycle <= 1;
            document.getElementById('nextCycleBtn').disabled = currentCycle >= totalCycles;
        }
        
        async function changeCycle(delta) {
            const newCycle = currentCycle + delta;
            if (newCycle < 1 || newCycle > totalCycles) return;
            
            currentCycle = newCycle;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsContent').style.display = 'none';
            
            await fetchResults();
        }
        
        async function startNextCycle() {
            if (!isHost) {
                showNotification('Only the host can start the next cycle', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}?action=startNextCycle&hostId=${hostId}`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.gameCompleted) {
                        // Game completed, show final leaderboard
                        showFinalLeaderboard();
                    } else {
                        // Next cycle started
                        showNotification('Next cycle starting...', 'success');
                        localStorage.setItem('currentCycle', data.nextCycle);
                        
                        // Redirect to game after 2 seconds
                        setTimeout(() => {
                            window.location.href = 'game.html';
                        }, 2000);
                    }
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Network error: ' + error.message, 'error');
            }
        }
        
        async function showFinalLeaderboard() {
            try {
                const response = await fetch(`${BACKEND_URL}?action=getLeaderboard&hostId=${hostId}`);
                const data = await response.json();
                
                if (data.success) {
                    displayFinalLeaderboard(data.leaderboard);
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Network error: ' + error.message, 'error');
            }
        }
        
        function displayFinalLeaderboard(leaderboard) {
            // Hide current results, show final results
            document.getElementById('resultsContent').style.display = 'none';
            document.getElementById('finalResults').style.display = 'block';
            
            // Find winner
            if (leaderboard && leaderboard.length > 0) {
                const winner = leaderboard[0];
                document.getElementById('winnerName').textContent = winner.name;
                document.getElementById('winnerScore').textContent = `Final Score: ${winner.totalScore}`;
                
                // Find current player's rank and score
                const currentPlayer = leaderboard.find(p => p.name === playerName);
                if (currentPlayer) {
                    const rank = leaderboard.indexOf(currentPlayer) + 1;
                    document.getElementById('yourFinalRank').textContent = `#${rank}`;
                    document.getElementById('yourFinalScore').textContent = currentPlayer.totalScore;
                }
                
                // Update game statistics
                document.getElementById('totalCyclesPlayed').textContent = totalCycles;
                document.getElementById('totalPlayers').textContent = leaderboard.length;
            }
        }
        
        function returnToLobby() {
            window.location.href = 'lobby.html';
        }
        
        function playAgain() {
            // Clear game state and return to lobby
            localStorage.removeItem('currentCycle');
            window.location.href = 'lobby.html';
        }
        
        function goHome() {
            // Clear all game data
            const backendUrl = localStorage.getItem('backendUrl');
            localStorage.clear();
            localStorage.setItem('backendUrl', backendUrl);
            window.location.href = 'index.html';
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            
            if (type === 'error') {
                notification.classList.add('error');
            }
            
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Handle keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') {
                changeCycle(-1);
            } else if (e.key === 'ArrowRight') {
                changeCycle(1);
            }
        });
    </script>
</body>
      </html>
