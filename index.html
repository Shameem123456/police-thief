<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sheet Game Lobby</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #2c3e50; color: white; text-align: center; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: #34495e; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 90%; max-width: 400px; }
        h1 { margin-bottom: 20px; }
        input { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: none; box-sizing: border-box; }
        button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: #3498db; color: white; }
        .btn-secondary { background: #27ae60; color: white; }
        .btn-primary:hover { background: #2980b9; }
        
        .hidden { display: none; }
        
        /* Lobby Styles */
        .player-card { background: #ecf0f1; color: #2c3e50; padding: 10px; margin: 5px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .player-card.admin { border: 3px solid #f1c40f; } /* Highlight Admin */
        .player-card.ready { background: #2ecc71; color: white; }
        .badge { font-size: 0.8em; padding: 2px 6px; border-radius: 4px; background: #95a5a6; color: white; }
        .badge.admin-badge { background: #f39c12; }
        
        #game-status { font-size: 1.5em; color: #e74c3c; font-weight: bold; margin-top: 20px; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    
    <div id="screen-main">
        <h1>Game Portal</h1>
        <button class="btn-primary" onclick="showScreen('screen-create')">Create Room</button>
        <button class="btn-secondary" onclick="showScreen('screen-join')">Join Room</button>
    </div>

    <div id="screen-create" class="hidden">
        <h2>Create Room</h2>
        <input type="text" id="create-name" placeholder="Enter Your Name">
        <button class="btn-primary" onclick="createRoom()">Create & Enter</button>
        <button onclick="showScreen('screen-main')">Back</button>
    </div>

    <div id="screen-join" class="hidden">
        <h2>Join Room</h2>
        <input type="text" id="join-name" placeholder="Enter Your Name">
        <input type="number" id="join-id" placeholder="Room ID (6 digits)">
        <button class="btn-secondary" onclick="joinRoom()">Join Lobby</button>
        <button onclick="showScreen('screen-main')">Back</button>
    </div>

    <div id="screen-lobby" class="hidden">
        <h2>Room: <span id="lobby-room-id">...</span></h2>
        <div id="players-list">
            <p>Loading players...</p>
        </div>
        
        <div id="lobby-controls">
            <button id="btn-ready" class="btn-primary" onclick="setReady()">I'm Ready</button>
        </div>

        <div id="game-status" class="hidden">GAME IS ON!</div>
    </div>

</div>

<script>
    // --- PASTE YOUR DEPLOYED GOOGLE SCRIPT URL BELOW ---
    const API_URL = 'https://script.google.com/macros/s/AKfycbxroY62th8YX8bD1st0LFi7b2xhD1IlXjzYpgkTiYgVWHZXl5-e1Ofs7imItsaFzLCQuQ/exec';

    let currentPlayer = '';
    let currentRoom = '';
    let pollingInterval = null;

    function showScreen(id) {
        document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    // --- API HELPER ---
    async function postData(action, payload) {
        // We use 'no-cors' usually for GAS, but to read response we rely on text/plain + Redirect follow
        // Since GAS WebApp output is simple JSON, fetch usually works if set to "Anyone"
        const body = JSON.stringify({ action, ...payload });
        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                body: body
            });
            return await res.json();
        } catch (e) {
            console.error("Connection Error:", e);
            alert("Connection error or CORS issue. Ensure script access is 'Anyone'.");
        }
    }

    // --- ACTIONS ---

    async function createRoom() {
        const name = document.getElementById('create-name').value;
        if (!name) return alert("Name is required");

        const roomId = Math.floor(100000 + Math.random() * 900000); // 6 Digit ID
        currentPlayer = name;
        currentRoom = roomId;

        showScreen('screen-lobby');
        document.getElementById('lobby-room-id').innerText = roomId;
        
        // Call Backend
        await postData('create_room', { roomId, playerName: name });
        startPolling();
    }

    async function joinRoom() {
        const name = document.getElementById('join-name').value;
        const roomId = document.getElementById('join-id').value;
        
        if (!name || !roomId) return alert("Fill all details");

        const res = await postData('join_room', { roomId, playerName: name });
        
        if (res.status === 'success') {
            currentPlayer = name;
            currentRoom = roomId;
            showScreen('screen-lobby');
            document.getElementById('lobby-room-id').innerText = roomId;
            startPolling();
        } else {
            alert(res.message);
        }
    }

    async function setReady() {
        document.getElementById('btn-ready').disabled = true;
        document.getElementById('btn-ready').innerText = "Waiting for others...";
        await postData('set_ready', { roomId: currentRoom, playerName: currentPlayer });
    }

    // --- POLLING LOGIC ---
    function startPolling() {
        if (pollingInterval) clearInterval(pollingInterval);
        refreshLobby(); // Run immediately
        pollingInterval = setInterval(refreshLobby, 3000); // Run every 3 seconds
    }

    async function refreshLobby() {
        const data = await postData('get_lobby', { roomId: currentRoom });
        
        if (data && data.status === 'success') {
            const list = document.getElementById('players-list');
            list.innerHTML = ''; // Clear current list

            data.players.forEach(p => {
                const div = document.createElement('div');
                div.className = `player-card ${p.isAdmin ? 'admin' : ''} ${p.isReady ? 'ready' : ''}`;
                
                let badge = '';
                if (p.isAdmin) badge = '<span class="badge admin-badge">ADMIN</span>';
                if (p.isReady) badge += ' <span class="badge">READY</span>';

                div.innerHTML = `<span>${p.name} ${badge}</span>`;
                list.appendChild(div);
            });

            // Check Game Start
            if (data.gameStart) {
                document.getElementById('game-status').classList.remove('hidden');
                document.getElementById('lobby-controls').classList.add('hidden');
                // Stop polling to save resources, or keep polling if you need game state updates
                // clearInterval(pollingInterval); 
            }
        }
    }
</script>

</body>
</html>
