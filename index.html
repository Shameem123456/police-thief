<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sheet Game Lobby</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #2c3e50; color: white; text-align: center; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: #34495e; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 90%; max-width: 400px; }
        h1, h2 { margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: none; box-sizing: border-box; font-size: 16px; }
        
        button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 16px; }
        button:disabled { background: #95a5a6; cursor: not-allowed; opacity: 0.7; }
        
        .btn-primary { background: #3498db; color: white; }
        .btn-secondary { background: #27ae60; color: white; }
        .btn-back { background: #7f8c8d; color: white; }
        
        .btn-primary:hover:not(:disabled) { background: #2980b9; }
        .btn-secondary:hover:not(:disabled) { background: #2ecc71; }
        
        .hidden { display: none; }
        
        /* Lobby Styles */
        .room-code { background: #ecf0f1; color: #2c3e50; padding: 10px; font-size: 1.5em; letter-spacing: 5px; font-weight: bold; border-radius: 5px; margin-bottom: 20px; }
        
        .player-list { text-align: left; margin-bottom: 20px; }
        .player-card { background: rgba(255,255,255,0.1); padding: 10px; margin: 5px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .player-card.admin { border: 2px solid #f1c40f; }
        .player-card.ready { background: rgba(46, 204, 113, 0.3); border-left: 5px solid #2ecc71; }
        
        .badge { font-size: 0.7em; padding: 3px 6px; border-radius: 4px; background: #95a5a6; color: white; margin-left: 5px; }
        .badge.admin-badge { background: #f39c12; }
        .badge.ready-badge { background: #2ecc71; }
        
        #game-status { font-size: 2em; color: #e74c3c; font-weight: bold; margin-top: 20px; animation: pulse 1s infinite; text-transform: uppercase; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

<div class="container">
    
    <div id="screen-main">
        <h1>Game Portal</h1>
        <button class="btn-primary" onclick="showScreen('screen-create')">Create Room</button>
        <button class="btn-secondary" onclick="showScreen('screen-join')">Join Room</button>
    </div>

    <div id="screen-create" class="hidden">
        <h2>Create Room</h2>
        <input type="text" id="create-name" placeholder="Enter Your Name" maxlength="12">
        <button id="btn-create-submit" class="btn-primary" onclick="handleCreateRoom()">Create & Enter</button>
        <button class="btn-back" onclick="showScreen('screen-main')">Back</button>
    </div>

    <div id="screen-join" class="hidden">
        <h2>Join Room</h2>
        <input type="text" id="join-name" placeholder="Enter Your Name" maxlength="12">
        <input type="number" id="join-id" placeholder="Room ID (6 digits)">
        <button id="btn-join-submit" class="btn-secondary" onclick="handleJoinRoom()">Join Lobby</button>
        <button class="btn-back" onclick="showScreen('screen-main')">Back</button>
    </div>

    <div id="screen-lobby" class="hidden">
        <h2>Lobby Room</h2>
        <div class="room-code" id="lobby-room-id">------</div>
        
        <div id="players-list" class="player-list">
            <p style="text-align: center; opacity: 0.6;">Waiting for updates...</p>
        </div>
        
        <div id="lobby-controls">
            <button id="btn-ready" class="btn-primary" onclick="handleSetReady()">I'm Ready</button>
        </div>

        <div id="game-status" class="hidden">GAME IS ON!</div>
    </div>

</div>

<script>
    // ==========================================
    // CONFIGURATION
    // ==========================================
    const API_URL = 'https://script.google.com/macros/s/AKfycbxroY62th8YX8bD1st0LFi7b2xhD1IlXjzYpgkTiYgVWHZXl5-e1Ofs7imItsaFzLCQuQ/exec'; // <--- PASTE YOUR URL HERE
    const POLLING_INTERVAL_MS = 2000; // 2 Seconds
    // ==========================================

    let currentPlayer = '';
    let currentRoom = '';
    let pollingInterval = null;
    let isGameStarted = false;

    function showScreen(id) {
        document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    // --- API HELPER ---
    async function postData(action, payload) {
        const body = JSON.stringify({ action, ...payload });
        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                body: body
            });
            return await res.json();
        } catch (e) {
            console.error("Connection Error:", e);
            return { status: 'error', message: "Network Error" };
        }
    }

    // --- BUTTON HANDLERS ---

    async function handleCreateRoom() {
        const nameInput = document.getElementById('create-name');
        const btn = document.getElementById('btn-create-submit');
        const name = nameInput.value.trim();

        if (!name) return alert("Name is required");

        // Disable UI
        btn.disabled = true;
        btn.innerText = "Creating...";

        const roomId = Math.floor(100000 + Math.random() * 900000); // Generate 6 Digit ID

        // Call Backend
        const res = await postData('create_room', { roomId, playerName: name });

        if (res.status === 'success') {
            enterLobby(roomId, name);
        } else {
            alert("Error creating room: " + res.message);
            btn.disabled = false;
            btn.innerText = "Create & Enter";
        }
    }

    async function handleJoinRoom() {
        const nameInput = document.getElementById('join-name');
        const idInput = document.getElementById('join-id');
        const btn = document.getElementById('btn-join-submit');
        
        const name = nameInput.value.trim();
        const roomId = idInput.value.trim();
        
        if (!name || !roomId) return alert("Please fill in all fields");

        // Disable UI
        btn.disabled = true;
        btn.innerText = "Joining...";

        const res = await postData('join_room', { roomId, playerName: name });
        
        if (res.status === 'success') {
            enterLobby(roomId, name);
        } else {
            alert(res.message);
            btn.disabled = false;
            btn.innerText = "Join Lobby";
        }
    }

    async function handleSetReady() {
        const btn = document.getElementById('btn-ready');
        
        // Disable UI
        btn.disabled = true;
        btn.innerText = "Processing...";

        const res = await postData('set_ready', { roomId: currentRoom, playerName: currentPlayer });

        if (res.status === 'success') {
            btn.innerText = "Waiting for others...";
            // Button remains disabled because once ready, you can't un-ready (simple logic)
        } else {
            alert("Failed to set ready. Try again.");
            btn.disabled = false;
            btn.innerText = "I'm Ready";
        }
    }

    function enterLobby(roomId, name) {
        currentPlayer = name;
        currentRoom = roomId;
        
        showScreen('screen-lobby');
        document.getElementById('lobby-room-id').innerText = roomId;
        
        startPolling();
    }

    // --- POLLING LOGIC ---
    function startPolling() {
        if (pollingInterval) clearInterval(pollingInterval);
        refreshLobby(); // Run immediately
        pollingInterval = setInterval(refreshLobby, POLLING_INTERVAL_MS);
    }

    async function refreshLobby() {
        if (isGameStarted) return; // Stop heavy updates if game is already flagged on

        const data = await postData('get_lobby', { roomId: currentRoom });
        
        if (data && data.status === 'success') {
            const list = document.getElementById('players-list');
            list.innerHTML = ''; // Clear current list

            data.players.forEach(p => {
                const div = document.createElement('div');
                div.className = `player-card ${p.isAdmin ? 'admin' : ''} ${p.isReady ? 'ready' : ''}`;
                
                let badges = '';
                if (p.isAdmin) badges += '<span class="badge admin-badge">ADMIN</span>';
                if (p.isReady) badges += '<span class="badge ready-badge">READY</span>';
                
                // Highlight YOU
                const isMe = p.name === currentPlayer ? " (You)" : "";

                div.innerHTML = `<span>${p.name}${isMe}</span> <div>${badges}</div>`;
                list.appendChild(div);
            });

            // Check Game Start
            if (data.gameStart) {
                isGameStarted = true;
                document.getElementById('game-status').classList.remove('hidden');
                document.getElementById('lobby-controls').classList.add('hidden');
                // Optional: Stop polling or slow it down
                // clearInterval(pollingInterval); 
            }
        }
    }
</script>

</body>
</html>
