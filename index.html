<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spy Game</title>
    <style>
        /* BASE & LAYOUT */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a2e; color: #ecf0f1; text-align: center; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: #16213e; padding: 20px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.7); width: 95%; max-width: 500px; position: relative; }
        h1, h2 { color: #0f3460; text-shadow: 0 0 5px #e94560; margin: 0 0 20px 0; }
        
        /* INPUTS & BUTTONS */
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #0f3460; background: #0f3460; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 1rem; }
        button:disabled { background: #533440; cursor: not-allowed; opacity: 0.6; }
        
        .btn-primary { background: #e94560; color: white; }
        .btn-secondary { background: #0f3460; color: white; }
        .btn-primary:hover:not(:disabled) { background: #ff2e63; }
        
        .hidden { display: none !important; }
        
        /* CHAT BOX */
        #chat-section { margin-top: 20px; border-top: 2px solid #0f3460; padding-top: 10px; }
        #chat-display { height: 150px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 10px; text-align: left; font-size: 0.85rem; margin-bottom: 10px; border-radius: 4px; }
        .chat-msg { margin-bottom: 4px; }
        .chat-private { color: #f1c40f; }
        .chat-sender { font-weight: bold; color: #e94560; }
        
        /* GAME ELEMENTS */
        .player-card { background: rgba(255,255,255,0.05); padding: 8px; margin: 4px 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .player-card.active-turn { border: 2px solid #2ecc71; }
        
        /* FLIP CARD REVEAL */
        .reveal-container { perspective: 1000px; height: 200px; margin: 20px 0; cursor: pointer; user-select: none; }
        .flip-card { width: 100%; height: 100%; position: relative; transition: transform 0.6s; transform-style: preserve-3d; }
        .reveal-container:active .flip-card, .reveal-container.held .flip-card { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; justify-content: center; align-items: center; font-size: 2rem; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .card-front { background: #0f3460; color: #e94560; font-weight: bold; }
        .card-back { background: #e94560; color: white; transform: rotateY(180deg); font-size: 2.5rem; }
        
        /* VOTING */
        .vote-btn { background: #2c3e50; margin: 5px; width: 45%; display: inline-block; }
        .vote-btn.selected { background: #e67e22; border: 2px solid white; }

        /* SETTINGS GRID */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">

    <div id="screen-main">
        <h1>SPY GAME</h1>
        <button class="btn-primary" onclick="showScreen('screen-create')">Create Room</button>
        <button class="btn-secondary" onclick="showScreen('screen-join')">Join Room</button>
    </div>

    <div id="screen-create" class="hidden">
        <h2>New Mission</h2>
        <input type="text" id="c-name" placeholder="Agent Name">
        <div class="settings-grid">
            <div>
                <label>Imposters</label>
                <select id="c-imposters"><option value="1">1</option><option value="2">2</option></select>
            </div>
            <div>
                <label>Cycles</label>
                <select id="c-cycles"><option value="2">2</option><option value="3">3</option><option value="4">4</option></select>
            </div>
        </div>
        <button class="btn-primary" onclick="doCreate()">Launch</button>
        <button class="btn-secondary" onclick="showScreen('screen-main')">Back</button>
    </div>

    <div id="screen-join" class="hidden">
        <h2>Join Mission</h2>
        <input type="text" id="j-name" placeholder="Agent Name">
        <input type="number" id="j-room" placeholder="Room ID">
        <button class="btn-primary" onclick="doJoin()">Connect</button>
        <button class="btn-secondary" onclick="showScreen('screen-main')">Back</button>
    </div>

    <div id="screen-lobby" class="hidden">
        <h2>Room: <span id="lobby-id"></span></h2>
        <div id="player-list">Loading...</div>
        <button id="btn-ready" class="btn-primary" onclick="doReady()">Ready Up</button>
        <div id="lobby-msg" style="color: yellow; font-size: 0.8em;"></div>
    </div>

    <div id="screen-reveal" class="hidden">
        <h2>Your Identity</h2>
        <p>Hold card to see role. Memorize it!</p>
        <div class="reveal-container" onmousedown="holdCard(true)" onmouseup="holdCard(false)" ontouchstart="holdCard(true)" ontouchend="holdCard(false)">
            <div class="flip-card">
                <div class="card-front">HOLD TO REVEAL</div>
                <div class="card-back" id="secret-word">???</div>
            </div>
        </div>
        <div id="timer-display">Time: 60s</div>
    </div>

    <div id="screen-game" class="hidden">
        <h2>Cycle <span id="cycle-num">1</span></h2>
        <div id="turn-indicator" style="margin-bottom: 10px; color: #f1c40f;">Current Turn: ...</div>
        
        <div id="word-history" style="max-height: 100px; overflow-y: auto; background: rgba(0,0,0,0.2); margin-bottom: 10px; padding: 5px; text-align: left;">
            </div>

        <input type="text" id="game-word" placeholder="Type related word...">
        <button id="btn-submit-word" class="btn-primary" onclick="submitWord()">Send Word</button>
    </div>

    <div id="screen-vote" class="hidden">
        <h2>Identify Imposter</h2>
        <p>Tap a player to vote.</p>
        <div id="vote-list"></div>
        <button id="btn-cast-vote" class="btn-primary" onclick="submitVote()" disabled>Confirm Vote</button>
    </div>

    <div id="screen-result" class="hidden">
        <h2>Mission Report</h2>
        <div id="result-display"></div>
        <button class="btn-primary" onclick="location.reload()">New Game</button>
    </div>

    <div id="chat-section" class="hidden">
        <div id="chat-display"></div>
        <div style="display: flex; gap: 5px;">
            <select id="chat-target" style="width: 30%;">
                <option value="ALL">All</option>
            </select>
            <input type="text" id="chat-input" placeholder="Message..." style="margin:0;">
            <button onclick="sendChat()" style="width: 20%; margin:0;">Send</button>
        </div>
    </div>

</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxroY62th8YX8bD1st0LFi7b2xhD1IlXjzYpgkTiYgVWHZXl5-e1Ofs7imItsaFzLCQuQ/exec'; // <--- PASTE DEPLOY URL
    
    // STATE
    let me = { name: '', room: '', role: '' };
    let pollTimer = null;
    let phase = 'LOBBY';
    let localTimer = 60;
    let lastChatCount = 0;
    
    // --- ACTIONS ---

    async function doCreate() {
        const name = document.getElementById('c-name').value;
        const imp = document.getElementById('c-imposters').value;
        const cyc = document.getElementById('c-cycles').value;
        if(!name) return alert("Name Required");
        
        me.name = name;
        me.room = Math.floor(100000 + Math.random() * 900000);
        
        toggleLoading(true);
        await api('create_room', { playerName: name, roomId: me.room, imposters: imp, cycles: cyc });
        enterLobby();
    }

    async function doJoin() {
        const name = document.getElementById('j-name').value;
        const room = document.getElementById('j-room').value;
        if(!name || !room) return alert("Details Required");

        me.name = name;
        me.room = room;

        toggleLoading(true);
        const res = await api('join_room', { playerName: name, roomId: room });
        if(res.status === 'success') enterLobby();
        else { alert(res.message); toggleLoading(false); }
    }

    async function doReady() {
        document.getElementById('btn-ready').disabled = true;
        document.getElementById('btn-ready').innerText = "Waiting...";
        await api('set_ready', { roomId: me.room, playerName: me.name });
    }

    async function sendChat() {
        const msg = document.getElementById('chat-input').value;
        const target = document.getElementById('chat-target').value;
        if(!msg) return;
        document.getElementById('chat-input').value = '';
        await api('send_chat', { roomId: me.room, sender: me.name, target: target, message: msg });
    }

    async function submitWord() {
        const word = document.getElementById('game-word').value;
        if(!word) return;
        document.getElementById('btn-submit-word').disabled = true;
        await api('submit_word', { roomId: me.room, playerName: me.name, word: word });
        document.getElementById('game-word').value = '';
    }

    let selectedVote = '';
    function selectVote(targetName) {
        selectedVote = targetName;
        document.querySelectorAll('.vote-btn').forEach(b => b.classList.remove('selected'));
        event.target.classList.add('selected');
        document.getElementById('btn-cast-vote').disabled = false;
    }

    async function submitVote() {
        if(!selectedVote) return;
        document.getElementById('btn-cast-vote').innerText = "Voted";
        document.getElementById('btn-cast-vote').disabled = true;
        await api('submit_vote', { roomId: me.room, playerName: me.name, voteTarget: selectedVote });
    }

    // --- LOGIC ---

    function enterLobby() {
        showScreen('screen-lobby');
        document.getElementById('lobby-id').innerText = me.room;
        document.getElementById('chat-section').classList.remove('hidden');
        startPolling();
    }

    function startPolling() {
        if(pollTimer) clearInterval(pollTimer);
        pollTimer = setInterval(syncState, 2000);
        syncState();
    }

    async function syncState() {
        const data = await api('get_state', { roomId: me.room, playerName: me.name });
        if(!data || data.status !== 'success') return;

        // 1. UPDATE PLAYERS & CHAT
        renderPlayers(data.players);
        renderChat(data.chats, data.players);

        // 2. PHASE MANAGEMENT
        if (data.phase !== phase) {
            phase = data.phase; // Update local phase
            handlePhaseChange(data);
        }

        // 3. PHASE SPECIFIC UPDATES
        if (phase === 'GAME') {
            updateGameScreen(data);
        }
        if (phase === 'RESULT') {
            showResults(data);
        }
    }

    function handlePhaseChange(data) {
        // Switch screens based on phase
        if (phase === 'REVEAL') {
            showScreen('screen-reveal');
            document.getElementById('secret-word').innerText = data.secretWord;
            startTimer(60, () => { /* Server handles transition usually, but UI timer helps */ });
        } else if (phase === 'GAME') { // Renamed from PLAY in some logic, using GAME here
            showScreen('screen-game');
        } else if (phase === 'VOTE') {
            showScreen('screen-vote');
            renderVoteButtons(data.players);
        } else if (phase === 'RESULT') {
            showScreen('screen-result');
        }
    }

    function updateGameScreen(data) {
        // Cycle & Turn
        document.getElementById('cycle-num').innerText = data.gameState.currentCycle;
        
        const turnPlayer = data.players[data.gameState.turnIndex];
        const isMyTurn = turnPlayer.name === me.name;
        
        document.getElementById('turn-indicator').innerText = isMyTurn ? "YOUR TURN!" : `${turnPlayer.name} is typing...`;
        document.getElementById('game-word').disabled = !isMyTurn;
        document.getElementById('btn-submit-word').disabled = !isMyTurn;

        // History
        const histDiv = document.getElementById('word-history');
        histDiv.innerHTML = data.wordHistory.map(h => `<div><b>${h.player}:</b> ${h.word}</div>`).join('');
    }

    function renderPlayers(players) {
        const list = document.getElementById('player-list');
        list.innerHTML = players.map(p => 
            `<div class="player-card">
                <span>${p.name} ${p.isReady ? 'âœ…' : '...'}</span>
             </div>`
        ).join('');
    }

    function renderChat(chats, players) {
        // Update Target Dropdown if needed
        const sel = document.getElementById('chat-target');
        if(sel.options.length === 1) { // Only fill once to avoid reset
             players.forEach(p => {
                 if(p.name !== me.name) {
                     let opt = document.createElement('option');
                     opt.value = p.name;
                     opt.innerText = p.name;
                     sel.appendChild(opt);
                 }
             });
        }

        const div = document.getElementById('chat-display');
        div.innerHTML = chats.map(c => {
            const isPriv = c.target !== 'ALL';
            return `<div class="chat-msg ${isPriv ? 'chat-private' : ''}">
                <span class="chat-sender">${c.sender}</span>${isPriv ? ' (Private)' : ''}: ${c.msg}
            </div>`;
        }).join('');
        div.scrollTop = div.scrollHeight;
    }

    function renderVoteButtons(players) {
        const div = document.getElementById('vote-list');
        div.innerHTML = players.map(p => {
            if(p.name === me.name) return ''; // Can't vote self
            return `<button class="vote-btn" onclick="selectVote('${p.name}')">${p.name}</button>`;
        }).join('');
    }

    function showResults(data) {
        let counts = {};
        data.players.forEach(p => {
            if(p.voteTarget) counts[p.voteTarget] = (counts[p.voteTarget] || 0) + 1;
        });
        
        // Simple logic to find actual imposter
        const imposters = data.players.filter(p => p.role === 'Imposter').map(p => p.name);

        let html = `<h3>Imposters were: ${imposters.join(', ')}</h3>`;
        html += `<h4>Votes:</h4><ul>`;
        for (const [name, count] of Object.entries(counts)) {
            html += `<li>${name}: ${count} votes</li>`;
        }
        html += `</ul>`;
        document.getElementById('result-display').innerHTML = html;
        clearInterval(pollTimer); // Stop game loop
    }

    // --- UTILS ---
    function showScreen(id) {
        document.querySelectorAll('.container > div:not(#chat-section)').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id === 'screen-main') document.getElementById('chat-section').classList.add('hidden');
    }
    
    function toggleLoading(isLoading) {
        // Simple visual cue
        document.body.style.cursor = isLoading ? 'wait' : 'default';
    }

    function holdCard(isHolding) {
        const el = document.querySelector('.reveal-container');
        if(isHolding) el.classList.add('held');
        else el.classList.remove('held');
    }

    function startTimer(seconds, cb) {
        let t = seconds;
        const el = document.getElementById('timer-display');
        const interval = setInterval(() => {
            t--;
            el.innerText = `Time: ${t}s`;
            if(t <= 0) { clearInterval(interval); cb(); }
        }, 1000);
    }

    async function api(action, payload) {
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, ...payload }) });
            return await res.json();
        } catch(e) { console.error(e); return { status: 'error' }; }
    }
</script>

</body>
</html>
